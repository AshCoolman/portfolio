App.World3dView=App.SmartView.extend({templateName:"world-3d",className:"World3dView",label:"world-3d-view",tag:"canvas",materials:{},textures:{},VS:10,isControls:false,didInsertElement:function(){this._super();this.tryIntersect=[];this.$el.css("display","none");App.world3d=this;var p=400,k=300,o=45,n=p/k,f=0.1,a=10000;var g=this.scene=new THREE.Scene();var l=this.renderer=new THREE.WebGLRenderer({antialias:true,preserveDrawingBuffer:true});this.$el.append(l.domElement);$(l.domElement).addClass("world-3d-renderer");var j=this.camera=new THREE.OrthographicCamera(p/-2,p/2,k/2,k/-2,1,5000);j.position.set(p/2,0,1000);g.add(j);if(this.isControls){var r=this.controls=new THREE.TrackballControls(j);r.target.set(0,0,0);r.rotateSpeed=1;r.zoomSpeed=1.2;r.panSpeed=0.8;r.noZoom=false;r.noPan=false;r.staticMoving=true;r.dynamicDampingFactor=0;r.keys=[65,83,68];r.addEventListener("change",function(s){return function(){this.redraw}}(this))}var d=new THREE.AmbientLight(3355443).position.copy(new THREE.Vector3(0,0,50));g.add(d);var m=new THREE.DirectionalLight(16777215,1);m.position.set(0,0,1);g.add(m);if(App.DEBUG){this.cursor3D=new THREE.Mesh(new THREE.SphereGeometry(15,10,10),new THREE.MeshNormalMaterial());q.add(new THREE.PointLight(65280))}else{this.cursor3D=new THREE.Object3D()}var q=this.cursor3D;q.overdraw=true;g.add(q);var h=this.mouse2D=new THREE.Vector3(0,10000,0.5);var c=this.pickProjector=new THREE.Projector();isAnimating=true;var b=function(t){var s=function(v){var u=(this.lastRequestAnimationFrame)?v-this.lastRequestAnimationFrame:0;this.lastRequestAnimationFrame=v;t.redraw(u);t.set("raf",window.requestAnimationFrame(s))};return s}(this);this.set("raf",window.requestAnimationFrame(b));this.el.addEventListener("mousemove",function(s){return function(t){s.onDocumentMouseMove(t)}}(this),false);this.el.addEventListener("mousedown",function(s){return function(t){s.onDocumentMouseDown(t)}}(this),false);$(window).bind("resize.world3d",function(s){return function(){s.resize()}}(this));this.resize();var e=App.static_preloader.queue.getResult("face-ash-pixel");setTimeout(function(s){return function(){s.createFromImage(e);App.transitionView.clear()}}(this),100)},createFromImage:function(j){this.voxelPosition=new THREE.Vector3();this.tmpVec=new THREE.Vector3();this.normalMatrix=new THREE.Matrix3();this.$el.append('<canvas class="temp">');this.$tcanvas=$("canvas.temp",this.$el).css("display","none");this.tcanvas=this.$tcanvas[0];if(!this.tcanvas.getContext){setTimeout(function(c){return function(){c.createFromImage(j)}}(this),1000)}else{var a=[[[]]],o=12,k=12,e,l=this.tcanvas,p=l.getContext("2d"),d,b;p.drawImage(j,0,0);d=p.getImageData(0,0,o,k);b=d.data;for(var g=0;g<b.length;g+=4){e=g/4;if(b[g+3]==255){var n=e%o;var m=Math.floor(e/o);if(!a[n]){a[n]=[]}if(!a[n][m]){a[n][m]=[]}var f=(65536*b[g+0]+256*b[g+1]+b[g+2]).toString(16);a[n][m][0]={color:"#"+f}}}this.scene.add(this.cubeGroup=CubeGroup.createFromMap(a));this.$el.css("display","block")}},onDocumentMouseMove:function(b){b.preventDefault();var a=(b.clientX/window.innerWidth);if(!window.evented){window.evented=true}this.mouse2D.x=(b.layerX/this.w)*2-1;this.mouse2D.y=-(b.layerY/this.h)*2+1},onDocumentMouseDown:function(event){with(this){event.preventDefault();var intersects=raycaster.intersectObjects(cubeGroup.children,true);if(intersects.length>0){intersector=getRealIntersector(intersects);if(false){if(intersector.object!=plane){scene.remove(intersector.object)}}else{intersector=getRealIntersector(intersects);if(intersector){CubeGroup.tryAddHere(intersector)}}}}},resize:function(){var a,e,b=0,g,f=this.renderer,d=this.camera,c=this.tmpwinWidth=$(window).width();if(c>App.BREAKPOINT.WIDTH_2){a=App.BREAKPOINT.WIDTH_2;e=App.BREAKPOINT.HEIGHT_2;g="rgba(200, 255, 200, "+(b?1/b:1)+")"}else{if(c>App.BREAKPOINT.WIDTH_1){a=App.BREAKPOINT.WIDTH_1;e=App.BREAKPOINT.HEIGHT_1;g="rgba(200, 200, 255, "+(b?1/b:1)+")"}else{a=App.BREAKPOINT.WIDTH_0;e=App.BREAKPOINT.HEIGHT_0;g="rgba(255, 200, 200, "+(b?1/b:1)+")"}}$(f.domElement).attr({width:a+"px",height:e+"px"});if(App.DEBUG){$canvas.css("box-shadow","inset -1px -1px "+g)}f.setSize(a,e);d.left=-a/2;d.right=a/2;d.top=e/2;d.bottom=-e/2;d.position.set(200,-e/2,1000);d.updateProjectionMatrix();this.w=a;this.h=e;if(this.isControls){this.controls.handleResize()}},redraw:function(dur){if(typeof this["cubeGroup"]!="undefined"){with(this){raycaster=pickProjector.pickingRay(mouse2D.clone(),camera);var intersects=raycaster.intersectObjects(cubeGroup.children,true);if(intersects.length>0){intersector=getRealIntersector(intersects);if(intersector){setVoxelPosition(intersector);this.cursor3D.position=voxelPosition;CubeGroup.show(intersector)}}renderer.render(scene,camera)}}if(this.isControls){this.controls.update()}},getRealIntersector:function(a){for(i=0;i<a.length;i++){intersector=a[i];if(intersector.object!=CubeGroup.rollOverMesh){return intersector}}return null},setVoxelPosition:function(intersector){with(this){normalMatrix.getNormalMatrix(intersector.object.matrixWorld);tmpVec.copy(intersector.face.normal);tmpVec.applyMatrix3(normalMatrix).normalize();voxelPosition.addVectors(intersector.point,tmpVec);voxelPosition.x=Math.floor(voxelPosition.x/this.VS)*this.VS+this.VS/2;voxelPosition.y=Math.floor(voxelPosition.y/this.VS)*this.VS+this.VS/2;voxelPosition.z=Math.floor(voxelPosition.z/this.VS)*this.VS+this.VS/2}},addE3d:function(a){this.scene.add(a)},willDestroyElement:function(){CubeGroup.cleanup();this.tryIntersect=[];console.log("0");console.log("1");this.renderer=null;this.camera=null;this.controls=null;this.cursor3D=null;this.mouse2D=null;this.pickProjector=null;this.scene=null;this.lastRequestAnimationFrame=null;window.cancelAnimationFrame(this.get("raf"));this.el.removeEventListener("mousemove");this.el.removeEventListener("mousedown");$(window).unbind("resize.world3d");this.voxelPosition=null;this.tmpVec=null;this.normalMatrix=null;this.tcanvas=null;this.cubeGroup=null;this._super()}});