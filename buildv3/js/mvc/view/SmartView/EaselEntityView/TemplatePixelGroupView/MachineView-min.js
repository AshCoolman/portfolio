var MachineViewLed=function(){this.COL_POWER_OFF="#005500";this.COL_POWER_ON="#33CC33";this.COL_ACTIVITY_OFF="#557777";this.COL_POWER_ON="#5555CC";this.colOn="#33CC33";this.colStandBy="#33CC33";this.colOff="#005500";this.shp=null;this.clickFunc=null};MachineViewLed.prototype={init:function(a){this.colOn=a.colOn||this.colOn;this.colOff=a.colOff||this.colOff;this.colStandBy=a.colStandBy||this.colStandBy;this.shp=a.shp||this.shp;this.clickFunc=a.clickFunc||null;if(this.clickFunc){this.shp.cursor="pointer";this.shp.addEventListener("click",this.clickFunc,false);$(this.shp).on("rollover",function(b){this.filters=[new createjs.ColorFilter(120,120,120,1,120,120,120,0)];this.cache(0,0,this.width,this.width);update=true});$(this.shp).on("rollout",function(b){this.filters=[];this.cache(0,0,this.width,this.width);update=true})}},showOn:function(){this._show(this.colOn)},showStandBy:function(){this._show(this.colStandBy)},showOff:function(){this._show(this.colOff)},_show:function(a){if(this.shp){this.shp.graphics.clear();this.shp.graphics.beginFill(a);this.shp.graphics.drawRect(0,0,this.shp.width,this.shp.height)}},cleanUp:function(){if(this.clickFunc){this.shp.removeEventListener("click",this.clickFunc)}this.colOn=null;this.colOff=null;this.colStandBy=null;this.shp=null}};var MachineViewRayParticle=function(){this.COL_LIST=["#40FF00","#FFEA00","#FF00CB","#00FFEF","#008FFF"];this.col=null;this.shp=null;this.shpGlow=null;this.eslObj=null;this.tween=null;this.beamList=[];this.LEN=1;this.RANGE=App.PIXEL_SIZE*6};MachineViewRayParticle.prototype={init:function(h){var d,g;h.w=h.w||App.PIXEL_SIZE*this.LEN;h.h=h.h||App.PIXEL_SIZE;h.x=h.x||0;h.y=h.y||0;h.col=h.col||this.COL_LIST[Math.floor(Math.random()*this.COL_LIST.length)];this.eslObj=new createjs.Container();this.eslObj.addChild(this.shp=this.createShape(h));this.beamList=[];for(var c=0;c<5;c++){this.eslObj.addChild(this.beamList[c]=this.createShape(h))}this.eslObj.x=this.eslObj.proxyX=h.x;this.eslObj.y=this.eslObj.proxyY=h.y;d=function(k,j,b,i){return function(){j.x=j.proxyX-(j.proxyX%App.PIXEL_SIZE);j.y=j.proxyY-(j.proxyY%App.PIXEL_SIZE)}}(this,this.eslObj,h.w,h.h);d();g=function(b){return function(){b.eslObj.removeAllChildren();if(b.eslObj.parent){b.eslObj.parent.removeChild(b.eslObj);b.eslObj=b.shp=b.COL_LIST=b.col=null}b.cleanUp()}}(this);var a={alpha:0.2,proxyY:h.startY,proxyX:this.eslObj.proxyX+this.RANGE,onUpdate:d,onComplete:g};if(h.yTween){a.proxyY=h.yTween}if(h.xTween){a.proxyX=h.xTween}var f=TweenMax.to(this.eslObj,0.8,a);var e,c;bList=this.beamList,bNum=bList.length;for(e=0;e<bNum;e++){c=bList[e];c.x=App.PIXEL_SIZE*c;c.alpha=bNum-(c/bNum)}},createShape:function(b){var c=new createjs.Shape(),a=b.col;c.width=b.w;c.height=b.h;c.graphics.clear();c.graphics.beginFill(a);c.graphics.drawRect(0,0,c.width,c.height);return c},cleanUp:function(){this.COL_LIST=null;this.col=null;this.shp=null;this.eslObj=null;this.tween&&this.tween.kill&&this.tween.kill();this.tween=null}};App.MachineView=App.TemplatedPixelGroupView.extend({templateName:"machine",className:"MachineView",label:"machine",imgPreloadId:"machine-pixel",ledHash:{},isCreateFromImage:false,isOnObserver:function(b,d){var c=this.get("ledHash");if(this.get(d)){var a=setInterval(function(e){return function(){e.set("isActivity",!e.get("isActivity"))}}(this),1000);this.set("toggleActivityInterval",a);c.power&&c.power.showOn();c.activity&&c.activity.showStandBy()}else{clearInterval(this.get("toggleActivityInterval"));this.set("toggleActivityInterval",null);this.set("isActivity",false);c.power&&c.power.showOff();c.activity&&c.activity.showOff()}}.observes("controller.isOn"),toggleActivityInterval:null,isActivity:false,isActivityObserver:function(b,d){var c=this.get("ledHash");if(this.get(d)){c.activity&&c.activity.showOn();var a=this.shootRay();this.get("controller").doActivateTarget({ray:a})}else{if(this.get("controller.isOn")){c.activity&&c.activity.showStandBy()}else{c.activity&&c.activity.showOff()}}}.observes("isActivity"),activateOn:function(){},didInsertElement:function(){this._super();var b=this.get("pixelsFromImgMap")||[];for(var a=0;a<b.length;a++){for(var d=0;d<b[a].length;d++){var c=b[a][d][0];if(c&&c.container&&c.shp){this.trySetPowerLed(c.container,c.shp);this.trySetActivityLed(c.container,c.shp)}}}},willDestroyElement:function(){this._super();clearInterval(this.get("toggleActivityInterval"));this.set("toggleActivityInterval",null);var a=this.get("ledHash");if(a){a.power&&a.power.cleanUp();a.activity&&a.activity.cleanUp();a.power=a.activity=null}this.set("ledHash",a=null)},trySetPowerLed:function(b,d){var c=this.get("ledHash"),a;if(!c.power){a=function(e){return function(f){if(e.get("controller").isInteractive){e.get("controller").togglePower()}}}(this);c.power=Object.createFromPrototype(MachineViewLed,{clickFunc:a,shp:d});c.power.showOff()}},trySetActivityLed:function(a,c){var b=this.get("ledHash");if(b.power&&!b.activity&&b.power.shp!=c){b.activity=Object.createFromPrototype(MachineViewLed,{});b.activity.shp=c;b.activity.colOn="#EB9946";b.activity.colOff="#2e2e2e";b.activity.colStandBy="#773d32";b.activity.showOff()}},shootRay:function(){var e=this.get("eslObj"),c=[],d,g=this.get("controller.pixels"),b;for(var f=0;f<g.length;f++){b=g[f].get("view.eslObj");if(!d||b.x>d){d=b.x;c=[b]}else{if(b.x==d){c.push(b)}}}for(var a=0;a<4;a++){setTimeout(function(h){return function(){for(var k=0;k<c.length;k++){var j=Math.round(c.length/2);var i=Object.createFromPrototype(MachineViewRayParticle,{x:e.x+c[k].x,y:e.y+(j-1)*App.PIXEL_SIZE,yTween:e.y+c[k].y,xTween:e.x+c[k].x+Math.abs(App.PIXEL_SIZE*8)});e.parent.addChild(i.eslObj)}}}(this),a*200)}}});