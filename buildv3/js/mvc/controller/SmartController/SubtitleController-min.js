(function(){var b=0;var c=["ms","moz","webkit","o"];for(var a=0;a<c.length&&!window.requestAnimationFrame;++a){window.requestAnimationFrame=window[c[a]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[c[a]+"CancelAnimationFrame"]||window[c[a]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(h,e){var d=new Date().getTime();var f=Math.max(0,16-(d-b));var g=window.setTimeout(function(){h(d+f)},f);b=d+f;return g}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(d){clearTimeout(d)}}}());App.SubtitleController=App.SmartController.extend({controllerName:"Script Subtitle Controller",label:"SubtitleController",text:"",cursorChar:"&#0178;",atLine:0,atChar:0,atPrintedLine:0,srcLines:[],editList:[],printedLines:[""],isFreezeOnHover:true,counter:0,isHover:false,hoverEvent:undefined,isEdit:false,tagStart:"<p><span>",tagMid:"</span></p><p><span>",tagEnd:"</span></p>",tagCursor:'<img src="img/cursor.gif"/>',isForceFinish:false,isCursor:true,isLooping:false,isInstant:false,tagPositions:[],pendingClosingTags:[],actionTimeouts:[],pendingWait:0,lastPrinted:null,lastEdit:null,isHoverUnfinished:false,isCursorObserver:function(){if(this.get("isCursor")){this.set("tagCursor",'<img src="img/cursor.gif"/>')}else{this.set("tagCursor","")}var a=this.get("printedLines");if(a){this.setText(this.get("printedLines"),null);this.printText()}}.observes("isCursor"),lines:[],isEnded:false,isRemoved:false,hasRemoveButton:false,thescript:"",isRemoveButton:false,raf:null,lastRequestAnimationFrame:0,durSinceReadChar:0,setup:function(g){if(this.get("thescript")){g=this.get("thescript")}g=g.replace(/(\r\n|\n|\r)/gm,"\n");g=g.split("\r\n").join("\n");g=window.unescape(g);if(g.indexOf("@edits=")!=-1){this.set("isEdit",true)}var i=[""],e=g.split("\n"),a=0,b=0,k=0,c=[];for(var f=0;f<e.length;f++){var j;if(j=e[f].indexOf("@edits=")!=-1){var o=e[f].split("@edits="),n=o[1].split(" "),d=n.reverse().pop();n.reverse();e[f]=o[0].concat(n);d=d.split(",");for(var m in d){m=m.split("")}c.push({linePosition:f,charPosition:o[0].length,currentVal:0,atChar:0,currentDirection:1,editVals:d,printed:"",editPause:false,loops:true});f--}}this.set("tagPositions",[]);this.set("editList",c);for(var f=0;f<e.length;f++){e[f]=e[f].split("");if(e[f].length==0){e[f][0]="&nbsp;&nbsp;"}}if(c.length==0){for(var f=0;f<e.length;f++){var h=line=o0=o1=prevo1=0;if(((line=e[f])[0])!="@"){while((o0=line.indexOf("<"))!=-1&&(o1=line.indexOf(">",o0))!=-1){if(false&&prevo1&&prevo1==o0+1){line.splice(prevo1,1)}else{h=""}h+=line.splice(o0,o1-o0).join("");line.splice((prevo1=o0),0,h)}}}}this.setText([""]);this.set("atLine",a);this.set("atChar",b);this.set("atPrintedLine",k);this.set("printedLines",i);this.set("srcLines",e)},view_didInsertElement:function(a){this._super(a);this.send("SubtitleController_didInsertElement",this);this.set("content",App.scriptModel);this.setup()},view_willDestroyElement:function(){var b=this.get("actionTimeouts");for(var a in b){window.clearTimeout(a.id)}this.set("actionTimeouts",[]);this.set("isLooping",false);this.set("isEnded",true);this.doForceFinish();this.setText([""]);this.set("atLine",0);this.set("atChar",0);this.set("atPrintedLine",0);this.set("printedLines",[""]);this.set("srcLines",[])},readChar:function(dur,me,isEvents){var me=me||this,isEvents=(typeof(isEvents)!="undefined")?isEvents:true,srcLines=me.get("srcLines"),editList=me.get("editList"),printedLines=me.get("printedLines"),atLine=me.get("atLine"),atChar=me.get("atChar"),atPrintedLine=me.get("atPrintedLine"),delayChar=1/me.get("content").get("cpms"),delayLine=me.get("content").get("newLineDelay"),delayEditLine=me.get("content").get("editDelay"),isNewLine=false,delay=delayChar,currentEdit,isLastCharBeforeDisplay=false;if(dur>this.get("pendingWait")){dur-=this.get("pendingWait");this.set("pendingWait",0);if(atLine<srcLines.length){for(var e=0;e<editList.length;e++){if(editList[e].linePosition==atLine&&editList[e].charPosition==atChar){currentEdit=editList[e]}}if(currentEdit&&currentEdit.editPause){delay=delayEditLine}else{if(!currentEdit&&atChar>=srcLines[atLine].length){delay=delayLine}}if(dur>delay){dur-=delay;if(atChar==0&&atLine==0){isNewLine=true}else{if(atChar>=srcLines[atLine].length&&!currentEdit){isNewLine=true;atChar=0;atLine++;atPrintedLine++}}if(currentEdit){with(currentEdit){editPause=false;if(currentDirection==1){printed+=editVals[currentVal][atChar];atChar++;if((atChar+1)>editVals[currentVal].length){currentDirection=-1;editPause=true}}else{printed=printed.substring(0,printed.length-1);if(printed.length==0){currentDirection=1;atChar=0;currentVal++;editPause=true;if(currentVal>=editVals.length){currentVal=0}}}}me.set("editList",editList);me.setText(this.get("printedLines"),currentEdit.printed)}else{if(!isNewLine){printedLines[atPrintedLine]+=srcLines[atLine][atChar];me.setText(printedLines,null,"char");atChar++}else{if(isNewLine){while(isEvents&&srcLines[atLine]&&srcLines[atLine][0]&&srcLines[atLine][0]=="@"){var line=srcLines[atLine].join("");if(line.indexOf("@=")==0){this.doTagRead(line,atPrintedLine)}else{if(line.indexOf("@wait=")==0){var pendingWait=parseInt(line.split("=")[1],10);Em.assert("@wait was given non-number value",!isNaN(parseFloat(pendingWait))&&isFinite(pendingWait));this.set("pendingWait",pendingWait)}else{if(line.indexOf("@actionOnRead=")==0){var words=line.split(" ");var action=words[0].split("=")[1];var delay=(words[1]&&!isNaN(parseFloat(words[1]))&&isFinite(words[1]))?parseFloat(words[1]):0;var actionFunc=function(my,myAction,pos){return function(){var actionTOObjs=my.get("actionTimeouts");if(actionTOObjs[pos]){window.clearTimeout(actionTOObjs[pos].to);actionTOObjs[pos].to=null;my.send(myAction)}}}(this,action,this.get("actionTimeouts").length);var to=setTimeout(actionFunc,delay);this.get("actionTimeouts").push({func:actionFunc,to:to})}else{App.eventMapper.trigger(line.split(" ")[1])}}}atLine++}if(this.get("pendingWait")>=0){if(atLine<srcLines.length&&srcLines[atLine].length>0){printedLines[atPrintedLine]="";printedLines[atPrintedLine]+=srcLines[atLine][atChar];atChar++}}}}}}else{}}else{me.set("isEnded",true);me.set("isCursor",false);window.cancelAnimationFrame(me.get("raf"));if(me.get("hasRemoveButton")){me.set("isRemoveButton",true)}App.eventMapper.trigger("sub_finishedReading",{target:this})}}me.set("srcLines",srcLines);me.set("printedLines",printedLines);me.set("atLine",atLine);me.set("atChar",atChar);me.set("atPrintedLine",atPrintedLine);return dur},doEdit:function(b,a){},getTagCodeFromLine:function(a){var b=unescape(a).split("@=");b.splice(0,1);return b[0]},getClosedVersionOfTag:function(b){var a=(b.split(" ")[0]+">").split("");a=a.replace("\t","");a.splice(1,0,"/");return a.join("").replace(">>",">")},getMostRecentOpenTag:function(b){b.reverse();for(var a=0;a<b.length;a++){if(!b[a].isClosed){b.reverse();return b.length-a-1}}b.reverse();return -1},doTagRead:function(a,b){var g=this.get("pendingClosingTags"),f=this.get("tagPositions"),e=this.getTagCodeFromLine(a);if(e.charAt(1)!="/"){var c=f.length;f.push({lineOpened:b,code:e,expectedClosed:this.getClosedVersionOfTag(e),isClosed:false});g.push(f[c].expectedClosed)}else{var d=this.getMostRecentOpenTag(f);f[d].isClosed=true;f[d].lineClosed=b-1;g.pop()}this.set("pendingClosingTags",g);this.set("tagPositions",f)},createTaggedLines:function(f,i,a){var e=this.get("tagPositions"),i=i||"",c=this.get("pendingClosingTags"),j=f.slice(0),h=j.length-1;for(var d=0;d<j.length;d++){if(d==j.length-1){j[d]=this.tagStart+j[d]+" <i>"+i+"</i>"+this.get("tagCursor")+this.tagEnd}else{j[d]=this.tagStart+j[d]+" "+this.tagEnd}}e.reverse();for(var k=0;k<e.length;k++){var m=e[k],b=Math.min(m.lineOpened,h);if(m.lineOpened<=h){j[b]=m.code+j[b]}else{j[b]=j[b]+m.code}if(m.isClosed){var g=Math.min(m.lineClosed,h);j[g]=j[g]+m.expectedClosed}}e.reverse();j[h]=j[h]+c.join("");this.set("tagPositions",e);this.set("pendingClosingTags",c);return j.join("")},doRemoveClicked:function(){window.cancelAnimationFrame(this.get("raf"));this.set("isEnded",true);this.set("isRemoved",true);this.get("view").doRemove();this.setText("")},setText:function(b,a){this.set("lastPrinted",b);this.set("lastEdit",a)},printText:function(){if($(".text",$(this.get("view").get("element")))[0]){$(".text",$(this.get("view").get("element")))[0].innerHTML=this.createTaggedLines(this.get("lastPrinted"),this.get("lastEdit"))}},startReading:function(){if(this.get("isInstant")){this.get("view").doShowInstant();this.doForceFinish()}else{this.get("view").doShow();var a=function(c){var b=function(f){var e=c.get("lastRequestAnimationFrame"),d=c.get("durSinceReadChar");d+=(e?f-e:0);c.set("lastRequestAnimationFrame",f);if(!c.get("isHover")||!c.get("isFreezeOnHover")){d=c.reDraw(d,c)}else{d=0}c.set("durSinceReadChar",d);if(!c.get("isEnded")||c.get("isLooping")){c.set("raf",window.requestAnimationFrame(b))}};return b}(this);this.set("raf",window.requestAnimationFrame(a))}},getLinkEvent:function(){this.send(this.get("linkEvent"))},doClicked:function(){if(this.get("linkEvent")){this.send(this.get("linkEvent"))}this.doForceFinish()},doHover:function(a){if(this.get("hoverEvent")){this.send(this.get("hoverEvent"),a)}},reDraw:function(a,b){var c=a;while(c!=(a=b.readChar(a,b))){c=a}this.printText();return a},doForceFinish:function(){this.set("isHoverUnfinished",false);this.set("editList",[]);window.cancelAnimationFrame(this.get("raf"));while(!this.get("isEnded")){this.readChar(99999,this,true)}this.printText()}});App.register("controller:subtitle",App.SubtitleController,{singleton:false});